## 常见面试题

##### 大表怎么优化？某个表有近千万数据，CRUD比较慢，如何优化？

核心思路

 - 大表变小表
 - 缓存(一次计算 多次使用)

单表记录数过大时，一些常见的优化措施如下：

 - 通过分库分表的方式进行优化，主要有垂直分表和水平分表
 - 缓存： 使用MySQL的查询缓存，另外对重量级、更新少的数据可以在应用层面进行缓存;
 - 读/写分离： 经典的数据库拆分方案，主库负责写，从库负责读；
 - 限定数据的范围： 务必禁止不带任何限制数据范围条件的查询语句(使用where条件)
 

##### 分库分表了是怎么做的？分表分库了有什么问题？
    
 - 水平拆分: 保持数据表结构不变，**通过某种策略存储数据分片(例如取模hash确定表名)**。
   这样每一片数据分散到不同的表或者库中，达到了分布式的目的。水平拆分可以支撑非常大的数据量。(一个表变多个表,表之间结构相同)
 - 垂直拆分: 根据数据列的使用频繁程度进行拆分,(一个表变多个表,表之间结构不一样)

垂直拆分
 
 - 垂直拆分的优点： 可以使得行数据变小，在查询时减少读取的Block数，减少I/O次数。此外，垂直分区可以简化表的结构，易于维护。
 - 垂直拆分的缺点： 主键会出现冗余，需要管理冗余列，并会引起Join操作，可以通过在应用层进行Join来解决。此外，垂直分区会让事务变得更加复杂；

水平拆分

分表仅仅是解决了单一表数据过大的问题，如果目的是提升MySQL并发能力，但由于表的数据还是在同一台机器上,IO瓶颈还是没有德到解决.那么水平拆分最好分库.
水平拆分能够,支持非常大的数据量存储，应用端改造也少，但**分片事务难以解决 ，分片数据Join性能较差，逻辑复杂**。

尽量不要对数据进行分片，因为拆分会带来逻辑、部署、运维的各种复杂度 ，**一般的数据表在优化得当的情况下支撑千万以下的数据量是没有太大问题的**。
**如果实在要分片，尽量选择客户端分片架构**，这样可以减少一次和中间件的网络I/O.

数据库分片的两种常见方案：

 - 客户端代理： 分片逻辑在应用层，比如说在开发框架里实现分片逻辑.
 - 中间件代理： 在应用和数据中间加了一个代理层。分片逻辑统一维护在中间件服务中.应用层向调用单机一样调用中间件

##### 分布式存储带来的问题

###### 事务支持 

分库分表后，就成了分布式事务了。
如果依赖数据库本身的分布式事务管理功能去执行事务，将付出高昂的性能代价；
如果由应用程序去协助控制，形成程序逻辑上的事务，又会造成编程方面的负担。
 
###### 数据聚合问题

跨节点的count,order by,group by,join 以及聚合函数问题 这些是一类问题，
因为它们都需要基于全部数据集合进行计算。多数的代理都不会自动处理合并工作。
解决方案：分别在各个节点上得到结果后在应用程序端进行合并。(虽然对应用层的编程有较大负担,但这也是一个办法)
与join不同的是有些聚合操作中的结点的查询可以**并行执行**，因此很多时候它的速度要比单一大表快很多。
但如果结果集很大，对应用程序内存的消耗是一个问题。

###### ID问题

一旦数据库被切分到多个物理结点上，我们将不能再依赖数据库自身的主键生成机制。
一方面，某个分区数据库自生成的ID无法保证在全局上是唯一的；
另一方面，应用程序在插入数据之前需要先获得ID,以便进行SQL路由. 这就涉及到一些常见的主键生成策略.

###### 数据迁移，容量规划，扩容等

... 这些方案都不是十分的理想，多多少少都存在一些缺点，这也从一个侧面反映出了Sharding扩容的难度。
    
##### 有用到中间件么？他们的原理知道么？

tidb,分布式数据库

##### MySQL数据库cpu飙升到500%的话他怎么处理？

1  先用操作系统命令 top 命令观察是不是 mysqld 占用导致的
2  `show processlist`，看看里面跑的`session`情况，是不是有消耗资源的`sql`在运行。找出消耗高的`sql`
3  根据session情况,分析是因为单个sql导致负载太高,还是连接数太多导致负载过高.然后制定相关措施

#### 读写分离如何实现

两种方案 

    从应用层实现读写分离,使用分布式事务支持.
    从代理层实现读写分离,使用中间件 mysql-proxy 代理

读写分离的基础是主从复制.